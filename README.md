
# Техническое описание

Для следующего человека, который возьмется за этот проект, я оставляю примерное описание тех модулей, которые считаю нужным описать, а так же неполный список того, что не закончено или работает плохо.  

Работа над проектом велась чуть меньше 2-х месяцев. 
# Архитектура

Большинство архитектурных решений в том или ином формате взято из Unite Austin 2017 по Scriptable Objects. 
https://www.youtube.com/watch?v=raQ3iHhE_Kk&t=2473s&ab_channel=Unity
В проекте полно мест, где приминение принципов из этого видоса было излишне. 

# Character Controller

У персонажа есть следующий мувмент:

* Набор скорости (D)
* Остановка (Q)
* Прыжок (W)
* Слайд (S)
* Передвижение в воздухе, air dash (Удержание A в воздухе)
* Дэш - при активации скорость персонажа увеличивается, а препятствия на пути не представляют угрозы. Активируется на D, если было собрано 500 монет или после поднятия соответствующего усиления (бустера)

## Вертикальный мувмент. Transfrom.Translate()

Для вертикального мувмента используется эта хуйня, часто не в FixedUpdate, что естественно косяк. У меня было в списке миграция к Rigidbody2D, но руки не дошли.

Так же, персонаж может найти на уровне следующие виды бустеров:

* Магнит
* Щит
* Удвоение монет
* Дэш

Контроллер персонажа держится на State Machine с канал git-amend, но очень кривом варианте, очень много логики размазано по разным частям проекта. Из очевидных косяков, которые я могу вспомнить:

* Добавлен FuncPredicate в дополнение к ActionPredicate - аналог метода Enter() в стейте, только в друго месте, абсолютно бесполезная вещь, только усложняет код
* Так как Дэш может быть вызван не только инпутом игрока, его логика вынесена в метод EnterDashState(), но, если мне не изменяет память, есть еще темные места в коде, без которых дэш не будет работать.
* Нет промежуточных стейтов между движениями. Например, при прыжке, слайде или аэр дэше сразу происходит переход в новое состояние, несмотря на то, что есть анимации перехода из одного мувмента в другой

Для обработки неуязвимости после щита/дэша используется отдельная стейт машина.

Так же, в игре можно получить доп. жизни, при потере таковой происходит переход в дэш.

# Input System

Используется SO InputReader, взят у Sasquatch, привожу ссылки на гайды на ютабе

https://www.youtube.com/watch?v=wzPputN4Ts4&t=360s&ab_channel=SasquatchBStudios

https://www.youtube.com/watch?v=--_CH5DYz0M&ab_channel=git-amend - раздел Handling Input


# Чанки


Локации (не считая файтов с боссами) поделены на чанки. Дэфолтный чанк представляет собой Prefab длиной в 36 юнитов (по координате x, это важное значение). Prefab хранит в себе все объекты, с которыми игрок может взаимодействовать (монеты, подбираемые предметы, враги, препятствия и проч.).
В Root-объект префаба можно добавить скрипт Custom Size Chunk и передать в него два Transfrom'а, тем самым указав левую и правую границы чанка. Без этого компонента, правая граница чанка будет приниматься за 18.05 юнитов по локал трансформу объекта.

Фон локации спавнится отдельно от чанков. 

## Горизонтальный мувмент

Игра двигает чанки, а не персонажа. Координата X у персонажа остается неизменной. Перемещение происходит с помощью transform.Translate(). 
Формула для набора скорости сгенерирована ChatGPT на раннем этапе проекта, когда не было известно, что игрок сам может контроллировать скорость передвижения. Софт кап значения около 28 у. е. если мне не изменяет память. Это значение записывается в Scriptable Object (далее - SO) и используется в проекте повсеместно.

## Спавн

Когда правая граница чанка приближается к игроку (в коде это магическое число в виде 20f или 18f по-хорошему нужно учитывать размер камеры и вести расчеты исходя из него, потому что игра сейчас оптмизирована только под Aspect Ratio 16:9), спавнится следующий чанк (или несколько). Object Pooling'а нет, исползуется встроенный Instantiate().

## Параллакс

Фон имеет эффект параллакса. Технически, это реализовано передвижением со скоростью, отличной от скорости движения чанков к персонажу. Как было сказано выше, эта скорость записывается в SO. 
На данный момент реализовано 4 слоя параллакса:

* Небо
* Поле (в проекте именуется как "back")
* Дорога (3-х видов, при каждой генерации выберается рандомом)
* Пеньки (двигаются быстрее скорости чанка)

На данный момент спрайты дороги движутся со скоростью чанков, умноженной на 0.8 (Speed.Value * multiplier, где Speed - SO с оригинальным значением скорости, multiplier = 0.8)
В текущей реализации параллакса проблемы начинаются тогда, когда необходимо расположить в параллаксе объект, который должен взаимодействовать с игроком. 

Например:
* Магазин (остановиться - нажать E)
* Чанки с катсценами
* Враги на специальном типе чанков - Deers

Проблема в том, что передвижение в параллаксе происходит с уменьшенной скоростью, а спавн новых чанков завязан на границы объекта чанка. Кривизну этой системы можно увидеть при тесте текущей реализации carnaval_chunks.

Также, такие спрайты (например, спрайт магазина или дерева из victim_chunk) нарисованы на фоне дороги. Все бы ничего, только в текущей системе проблема в том, что рандомный спавн фона дороги накладывается на нерандомный фон спрайта. 

Решение этой проблемы состоит в изменении системы спавна объектов фона и добаление возможности добавлять объекта для спавна в рантайме.
### Спрайты, разделенные на два

Художник предаставляет 2 спрайта неба, которые должны появляться на сцене друг за другом. У каждого спрайта есть собственная анимация. Проблема с текущей системой спавна параллакса в том, что анимация рассинхронится. Я пробовал это пофикисить, но фиксы работают нестабильно.

Причину наличия двух спрайтов с двумя анимациями вместо одного следует уточнить у Художника, но по моим предположениям причины в следующием:
1. Размер изображения для пиксель арта излишне велик (достаточно закинуть любой спрайт из проекта в Aseprite, выставить размер кисти в 1px и сравнить с размером пискеля на изображении)
2. Художник не хранит в юнити спрайты больше 2048 пикселей (Texture max size -> 2048).

Подчеркиваю, это только мои предположения


## Рандом

По диздоку, в игре есть несколько видов чанков. Чанки должны спавниться при определенных условиях. 

В среднем чанков каждого типа около 15-20. Типы чанков на данный момент:

* По-умолчанию
* После 1-й минуты в забеге (начинают появляться после того, как забег длится больше одной минуты)
* После 2-х минут
* После 3-х минут
* После 5-и минут
* После 10-и минут
* С бустерами (появляются каждые 40 секунд)
* С едой (появляются 2 раза в течении 2-х минут)
* С существами (creatures, появляются каждые 2 минуты)
* С магазином (каждые 3 минуты)
* Сейв чанк (появляется перед магазином)
* Карнавал (каждые 10 минут)
* Босс (каждые 5 минут)
* Ивент (условия для спавна не имплементировано см. диз. док)

![Pasted image 20241130134655](https://github.com/user-attachments/assets/819f5711-93d0-4b7e-9f10-9a7b33d2120d)


### Chunk

Chunk хранит в себе префаб, значение веса, bool значения BecomeUnavailableAfterSpawn, IsAvailable и RestoreCondition.

Флаги и ResotreCondition предоставляют возможность спавнить чанк только один раз за забег и восстанавливать возможность для спавна по определенному условию (RestoreCondtition никогда не пригодилось кста, но возможность такая есть).


### ChunkList

Хранит в себе List<*Chunk*>

### Condition Data (SO)

Этот SO хранит в себе данные, необходимые для проверки услоия спавна чанков. Например, TimeCondition хранит FloatVariable Timer и float значение времени, после которого должен начаться спавн чанков. У этого объекта есть только один public метод Inti(), который возвращает новый экземпяр класса, который импленетирует логику на основе данных в SO. 

### Condition Logic (ChunkSpawnCondition.cs)

Класс, который непосредственно занимается проверкой условия для спавна чанков. Хранит два метода - Evaluate и ResetTrigger, и данные из соответствующего SO + все необходимые для логики private поля.

Evalute вызвается перед каждым спавном нового чанка.

Причина разделения Condition на две разных сущности состоит в том, что для проверки условий необходимо хранить дополнительные изменямые данные для каждого экземпялара условия. Хранение таких данных в SO предаставляет доступ к таким данным каждой сущности, которая использует этот SO. Соответственно изменения отражаются на каждой сущности. 

### Chunk Set 

Хранит в себе ChunkList, список условий, по которым чанк из данного списка может заспавниться. (между условиями логическое "и"), и int значение приоритета. Если при проверке условия есть несколько подходящих коллекций чанков для спавна, на рандоме выбирается одна из всех.

### Chunk Random Manager

SO, который хранит в себе всю логику по выборке чанков перед спавном. Реализуется в MonoBehaviour ChunkSpawnManager.

# UI

Весь UI сделан через одно место, есть объекты котоыре вообще находятся не в Canvas (например панель магазина), + написана кастомная ультра кривая система навигации по UI. 

# TODO

## Known bugs

1. Загрузочные экраны проставлены не везде и в них используются не ориг. картинки
2. В Лидерборде не сделана фича со звуком, если долистать до конца + можно скроллить выше/ниже границ лидерборда
3. Правки по дэш индикатору не внесены
4. Счетчик монет не прячется со временем
5. Звуки могу работать странно
6. Загрузка сцен занимает дохуя времени
7. Настройка графики ничего не делает
8. Визуалные баги по UI
9. Окно магазина не пересено в Canvas из-за чего основной UI сейчас перекрывает его + может не работать на разном разрешении экрана
10. Коты на чанке двигаются не соответственно рефу из дока
11. Прохождение босса не протестчено
12. При слишком быстром переходе из одного мувмента в другой могут возникать баги с анимацией
13. Иногда анимация смерти не проигрывается
14. Иногда инпут не разблокируется после рестарта локации
15. Иногда если у тебя 3 еды чанк с едой заспавнится без неё
16. Смена яркости отключена
17. Часто расстояние между противниками слишком мало, что руинит забег
18. Параллакс в карнавал чанках может спавниться чуть раньше или позже самих чанков
19. Иногда сейв записывает в качестве ID айтемов нули, что ломает инвентарь
20. Коллайдеры у некоторых Psilocybes не позволяют перепрыгнуть их, только пролететь в баунсе
21. Чанки с ilanemos не всесены в список спавна
22. При первом запуске игры уровень громкости выставлен на 4, рекомендую прикрутить громкость в микшере перед запуском чтобы на охуеть в случае чего.
23. Ивенты сейчас не спавнятся
24. Могут быть баги в спавне чанков
25. Звуки активных бустеров почти не слышно
26. При заходе в настройки вылезет эксепшн из-за яркости
27. При старте игры выпадает эксепшн из-за загрузки сейв файла (хз на что влияет)
28. Если купить апгрейд в магазине и выйти из игры, он не сохранится, так как я забыл прописать там сейв(а сам сейв чанк стоит перед магазином)
29. На боссах невозможно открыть Collectables panel
30. У GOD старый саундтрек
31. Упрвление на геймпаде не протестчено, возможно оно отсутствует (навигация по UI так точно)
32. Во время босс чанка не отключено управление
33. Анимация потери жизни багована

## Unimplemented

* Сейв файлы не защищены
* Acheivements
* Tutorial
* Управление для мобилок
* Оптимизация
* UI навигация для мобилок
